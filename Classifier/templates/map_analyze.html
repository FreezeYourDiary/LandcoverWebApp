{% extends 'base.html' %}
{% load static %}

{% block title %}Narzdzie do analizy wybranego obszaru{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
<link rel="stylesheet" href="{% static 'app.css' %}">
<link rel="stylesheet" href="{% static 'map.css' %}">
<link rel="stylesheet" href="{% static 'details.css' %}">
    <link rel="stylesheet" href="{% static 'history.css' %}">

{% endblock extra_css %}

{% block content %}
<div id="main-container">
  <div id="map-pane">
    <div id="map"></div>
  </div>

  <div id="splitter"></div>

  <div id="results-pane">
    <h2 style="margin-top: 0;">Analiza statystyczna wybranego obszaru</h2>

    <div class="card" id="progressPanel">
        <h2 style="margin: 0;">Progres</h2>
      <div class="progress-step pending">wyodrbnianie kafelk贸w mapy</div>
      <div class="progress-step pending">przycinanie obszaru</div>
      <div class="progress-step pending">analiza obszaru</div>
      <div class="progress-step pending">zapis statystyk</div>
    </div>
        <div class="card" id="imagesCard" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
        <h3 style="margin: 0;">Wizualizacja</h3>
      </div>

<div style="display: flex; justify-content: center; gap: 0.5rem; margin-bottom: 1rem;">
  <button class="image-control-btn active btn-small" data-view="original">Orygina</button>
  <button class="image-control-btn btn-small" data-view="mask">Maska</button>
  <button class="image-control-btn btn-small" data-view="blended">Overlay</button>
  <button class="image-control-btn btn-small" data-view="residential" id="residentialBtn" style="display: none;">Zabudowa miejska</button>
</div>

<div style="position: relative; width: 100%; background: var(--bg-light); border-radius: 4px; overflow: hidden;">
  <button id="downloadActiveBtn"
          class="image-control-btn download-overlay-btn btn-small"
          title="Pobierz obraz"
          style="display: none;"> Pobierz</button>

  <div style="padding-top: 75%;"></div>
  <div class="image-layer active" data-layer="original"
       style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; opacity: 1; transition: opacity 0.3s; overflow: auto;">
    <img id="originalImage" alt="Original" style="max-width: 100%; max-height: 100%; object-fit: contain; cursor: zoom-in;">
  </div>
  <div class="image-layer" data-layer="mask"
       style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; overflow: auto;">
    <img id="maskImage" alt="Classification" style="max-width: 100%; max-height: 100%; object-fit: contain; cursor: zoom-in;">
  </div>
  <div class="image-layer" data-layer="blended"
       style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; overflow: auto;">
    <img id="blendedImage" alt="Overlay" style="max-width: 100%; max-height: 100%; object-fit: contain; cursor: zoom-in;">
  </div>
    <div class="image-layer" data-layer="residential"
       style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; overflow: auto;">
    <img id="residentialImage" alt="Residential Area" style="max-width: 100%; max-height: 100%; object-fit: contain; cursor: zoom-in;">
    </div>
</div>

    </div>
    <div class="card" id="statsContainer">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3 style="margin: 0;">Statystyki</h3>
        <div style="display: flex; gap: 0.5rem;">
          <button id="viewRawJsonBtn" class="json-action- btn-small" title="Poka偶 surowe dane" style="display: none;">Raw</button>
            <button id="downloadJsonBtn" class="json-action-btn btn-small" title="Pobierz JSON" style="display: none;"></button>
        </div>
      </div>

      <div id="tabsHeader"></div>
      <div id="statsBars">Analiza rozpocznie si po wybraniu strefy, kt贸r chcesz przeanalizowa na mapie.</div>
    </div>


  </div>
</div>

<dialog id="paramModal">
  <div class="modal-header">
    <h3 style="margin: 0;">Skonfiguruj analiz</h3>
  </div>

  <form id="paramForm">
    <div class="config-group">
      <label for="modelSelect">Wybierz model:</label>
      <select id="modelSelect">
        <option value="Classifier/inputs/networks/mobilenetv2_v1.keras">MobileNetV2 v1 (Zalecany)</option>
        <option value="Classifier/inputs/networks/mobilenetv2_2.keras">MobileNetV2 v2</option>
      </select>
    </div>

    <div class="config-group">
      <label for="analysisMode">Poziom analizy:</label>
      <select id="analysisMode">
        <option value="detailed" selected>Szczeg贸owy (32x32 hierarchiczny)</option>
        <option value="fast">Szybki (64x64)</option>
      </select>
      <p class="config-help" style="font-size: 0.875rem; color: var(--text-light); margin-top: 0.5rem;">
        Szczeg贸owy: najlepsza jako, wolniejszy<br>
        Szybki: dobra jako, szybszy
      </p>
    </div>

      <div class="config-group">
          <label class="checkbox-label">
            <input id="smoothing" type="checkbox" checked/>
            <span> Wygadzenie ssiadowe </span>
          </label>
        </div>

        <div class="config-group">
          <label class="checkbox-label">
            <input id="interpolation" type="checkbox" checked/>
            <span> Interpolacja prawdopodobiestw </span>
          </label>
          <p class="config-help" style="font-size: 0.875rem; color: var(--text-light); margin-top: 0.5rem;">
            Gadkie przejcia midzy klasami zamiast kafelk贸w
          </p>
        </div>

        <div class="config-group">
          <label class="checkbox-label">
            <input id="simplifiedClasses" type="checkbox"/>
            <span> Uproszczone klasy (8 zamiast 10) </span>
          </label>
          <p class="config-help" style="font-size: 0.875rem; color: var(--text-light); margin-top: 0.5rem;">
            Usuwa Industrial i Highway, czy Herbaceous z Forest
          </p>
        </div>
        <!-- END NEW -->

        <div class="config-group">
          <label class="checkbox-label">
            <input id="fixSeaLake" type="checkbox"/>
            <span> Napraw izolowane jeziora </span>
          </label>
        </div>
  </form>

  <div class="modal-controls">
    <button id="cancelBtn" class="btn-secondary btn-small" type="button">Odrzu</button>
    <button id="runAnalyzeBtn" class="btn-primary btn-small" type="button">Zacznij analiz</button>
  </div>
</dialog>
{% endblock content %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<script>
  const CLASS_COLORS_RGB = {
    "AnnualCrop": "rgb(0,217,255)",
    "Forest": "rgb(0, 255, 0)",
    "HerbaceousVegetation": "rgb(100, 200, 100)",
    "Highway": "rgb(255,0,0)",
    "Industrial": "rgb(80,80,80)",
    "Pasture": "rgb(0, 200, 0)",
    "PermanentCrop": "rgb(200, 255, 100)",
    "Residential": "rgb(165,165,165)",
    "River": "rgb(255,242,0)",
    "SeaLake": "rgb(255, 100, 255)"
  };

  const CLASS_NAMES_PL = {
    "AnnualCrop": "Uprawy jednoroczne",
    "Forest": "Las",
    "HerbaceousVegetation": "Rolinno zielna",
    "Highway": "Drogi",
    "Industrial": "Tereny przemysowe",
    "Pasture": "Pastwiska",
    "PermanentCrop": "Uprawy wieloletnie",
    "Residential": "Tereny mieszkalne",
    "River": "Rzeki",
    "SeaLake": "Jeziora i morza"
  };

  window.AppConfig = {
    classColors: CLASS_COLORS_RGB,
    classNamesPL: CLASS_NAMES_PL
  };
</script>

<script type="module" src="{% static 'js/main.js' %}"></script>
{% endblock extra_js %}