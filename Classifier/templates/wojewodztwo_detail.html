{% extends 'base.html' %}
{% load static %}

{% block title %} Analiza - {{ wojewodztwo.display_name }} wojewÃ³dztwo {% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'app.css' %}">
    <link rel="stylesheet" href="{% static 'map.css' %}">
    <link rel="stylesheet" href="{% static 'details.css' %}">
        <link rel="stylesheet" href="{% static 'history.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.css">
{% endblock extra_css %}

{% block content %}
    <div id="main-container">
        <div id="results-pane" style="width: var(--results-width); ">

            <div style="text-align: center; margin-bottom: 2rem;">
                <h1>{{ wojewodztwo.display_name }}</h1>
                <p style="color: var(--text-light);"> NiÅ¼ej przedstawiono analizÄ™ dla wybranego wojewÃ³dztwa. Statystyki
                    obejmujÄ… wÅ‚asne wzory Procentowego udziaÅ‚u,
                    Obliczenie caÅ‚kowitej powierzchni dla kaÅ¼dej klasy terenu w kmÂ² & GÄ™stoÅ›Ä‡ wystÄ™powania & Analiza
                    granic - Opis proporcji granic miÄ™dzy rÃ³Å¼nymi typami terenu. </p>
            </div>

            {% if has_analysis %}
                {% if analyses_count > 1 %}
                    <div class="analysis-selector">
                        <label for="analysisSelect" style="font-weight: 600; margin-bottom: 0.5rem; display: block;">
                            Wybierz analizÄ™ ({{ analyses_count }} dostÄ™pnych):
                        </label>
                        <select id="analysisSelect" onchange="window.location.href='?analysis_id=' + this.value">
                        </select>
                        <div class="analysis-info" id="analysisInfo"></div>
                    </div>
                {% endif %}

                {% if wojewodztwo_stats %}
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        {% for key, value in wojewodztwo_stats.items %}
                            <div class="card">
                                <h3 style="font-size: 0.875rem; color: var(--text-light); margin-bottom: 0.5rem; text-transform: uppercase;">{{ key }}</h3>
                                <p style="font-size: 1.5rem; font-weight: 700; margin: 0;">{{ value }}</p>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0;">Statystyki</h3>
                        <div style="display: flex; gap: 0.5rem;">
                            <button id="viewRawBtn" class="btn-small" title="View Raw JSON" style="padding: 0.5rem; font-size: 1.2rem;">
                                Raw
                            </button>
                            <button id="downloadBtn" class="btn-small" title="Download JSON" style="padding: 0.5rem; font-size: 1.2rem;">
                                ðŸ¢ƒ
                            </button>
                        </div>
                    </div>

                    <div id="tabsHeader"></div>
                    <div style="max-height: 1000px; overflow-y: auto;">
                        <canvas id="statsChart"></canvas>
                        <div id="statsTable"></div>
                    </div>
                </div>

            {% else %}
                <div class="card">
                    <div style="text-align: center; padding: 3rem;">
                        <h2 style="color: var(--text-light);">Brakuje analizy</h2>
                        <p style="color: var(--text-light); margin-bottom: 1.5rem;">
                            Odpal analizÄ™ by zobaczyÄ‡ statystyki
                        </p>
                        <button class="btn-primary btn-small" onclick="window.location.href='{% url 'wojewodztwa_list' %}'">
                            WrÃ³Ä‡ [strona analizy]
                        </button>
                    </div>
                </div>
            {% endif %}
        </div>

        <div id="splitter"></div>

        <div id="map-pane" style="width: var(--map-width); padding: 20px; overflow-y: auto; background: white;">
            {% if has_analysis %}
                <div class="card" style="height: 100%;">
                    <div style="display: flex; justify-content: center; gap: 0.5rem; margin-bottom: 1rem;">
                        <button class="image-control-btn active" data-view="original">
                            OryginaÅ‚
                        </button>
                        <button class="image-control-btn btn-small" data-view="mask">Maska</button>
                        <button class="image-control-btn btn-small" data-view="blended">Overlay
                        </button>
                        <button id="downloadCurrentBtn btn-small" class="image-control-btn">
                                ðŸ¢ƒ
                        </button>
                    </div>

                    <div id="imageContainer"
                         style="position: relative; width: 100%; background: var(--bg-light); border-radius: 4px; overflow: auto; cursor: grab;">
                        <div style="padding-top: 100%;"></div>

                        <div id="imageSpinner" class="image-spinner"
                             style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 100;">
                            <div class="spinner"></div>
                            <div style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-light);">Loading full
                                resolution...
                            </div>
                        </div>

                        <div class="image-layer active" data-layer="original"
                             style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; opacity: 1; transition: opacity 0.3s;">
                            <img id="originalImage"
                                 class="zoomable-image"
                                 alt="Original"
                                 style="max-width: 100%; max-height: 100%; object-fit: contain; transition: transform 0.3s;">
                        </div>

                        <div class="image-layer" data-layer="mask"
                             style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s;">
                            <img id="maskImage"
                                 class="zoomable-image"
                                 alt="Classification"
                                 style="max-width: 100%; max-height: 100%; object-fit: contain; transition: transform 0.3s;">
                        </div>

                        <div class="image-layer" data-layer="blended"
                             style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s;">
                            <img id="blendedImage"
                                 class="zoomable-image"
                                 alt="Overlay"
                                 style="max-width: 100%; max-height: 100%; object-fit: contain; transition: transform 0.3s;">
                        </div>
                    </div>
                    <div style="display: center; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <div style="display: flex; gap: 0.5rem; align-items: center;">

                            <button id="zoomOutBtn" class="btn-small"
                                    style="padding: 0.4rem 0.6rem; font-size: 1.2rem;" title="Zoom Out">âˆ’
                            </button>
                            <span id="zoomLevel"
                                  style="font-size: 0.875rem; min-width: 50px; text-align: center;">100%</span>
                            <button id="zoomInBtn" class="btn-small"
                                    style="padding: 0.4rem 0.6rem; font-size: 1.2rem;" title="Zoom In">+
                            </button>

                        </div>
                    </div>
                    <div style="padding: 1rem;">
  <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-light); border-radius: 4px; font-size: 0.875rem;">
    <strong>Opis:</strong> Na obrazie widzisz naÅ‚oÅ¼one granice maski na granice wojewÃ³dztwa.
    MoÅ¼esz pobraÄ‡ ten obrazek na potrzeby zadania lub dalszej analizy.
  </div>
</div>

                </div>
            {% endif %}
        </div>
    </div>
{% endblock content %}

{% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
  const CLASS_COLORS_RGB = {
    "AnnualCrop": "rgb(0,217,255)",
    "Forest": "rgb(8,234,16)",
    "HerbaceousVegetation": "rgb(100, 200, 100)",
    "Highway": "rgb(255,0,0)",
    "Industrial": "rgb(80,80,80)",
    "Pasture": "rgb(82,52,94)",
    "PermanentCrop": "rgb(0,200,200)",
    "Residential": "rgb(197,195,195)",
    "River": "rgb(255,242,0)",
    "SeaLake": "rgb(255, 100, 255)"
  };

    window.AppConfig = {
        hasAnalysis: {% if has_analysis %}true{% else %}false{% endif %},
        analysisId: {% if analysis %}{{ analysis.id }}{% else %}null{% endif %},
        analysesList: {{ analyses_list|safe }},
        analysesCount: {{ analyses_count }},

        {% if has_analysis %}
            stats: JSON.parse('{{ stats_json|escapejs }}'),
            tabs: JSON.parse('{{ tabs_json|escapejs }}'),
            polandAverages: {{ poland_averages|safe }},
            wojewodztwoName: '{{ wojewodztwo.name|escapejs }}',
        {% endif %}

        classColors: CLASS_COLORS_RGB
    };

    {% if has_analysis %}
        window.imageData = {{ image_data|safe }};
    {% endif %}
    </script>

    <script src="{% static 'js/details.js' %}"></script>
    <script src="{% static 'js/extra.js' %}"></script>
{% endblock extra_js %}